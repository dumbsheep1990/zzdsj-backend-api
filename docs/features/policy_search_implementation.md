# æ”¿ç­–æ£€ç´¢å·¥å…·å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†åŸºäºæ”¿ç­–æ£€ç´¢çš„å†…ç½®æ£€ç´¢å·¥å…·çš„å®Œæ•´å®æ–½æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆå®ç°äº†æ™ºèƒ½åˆ†å±‚æ£€ç´¢ç­–ç•¥ï¼Œä¼˜å…ˆä½¿ç”¨åœ°æ–¹æ”¿åºœé—¨æˆ·ç½‘ç«™ï¼Œç„¶åçœçº§é—¨æˆ·ï¼Œæœ€åä½¿ç”¨æœç´¢å¼•æ“è¿›è¡Œå…œåº•æ£€ç´¢ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### ğŸ” æ ¸å¿ƒæ£€ç´¢åŠŸèƒ½
- **åˆ†å±‚æ£€ç´¢ç­–ç•¥**ï¼šåœ°æ–¹é—¨æˆ· â†’ çœçº§é—¨æˆ· â†’ æœç´¢å¼•æ“
- **æ™ºèƒ½è´¨é‡è¯„ä¼°**ï¼šæ ¹æ®ç»“æœè´¨é‡è‡ªåŠ¨åˆ‡æ¢æ£€ç´¢å±‚çº§
- **å¤šç§æ£€ç´¢æ¨¡å¼**ï¼šè‡ªåŠ¨ã€ä»…åœ°æ–¹ã€ä»…çœçº§ã€ä»…æœç´¢å¼•æ“
- **æ”¿ç­–ç±»å‹è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«æ”¿ç­–æ–‡ä»¶ç±»å‹å’Œéƒ¨é—¨ä¿¡æ¯
- **ç›¸å…³æ€§è¯„åˆ†**ï¼šåŸºäºå…³é”®è¯åŒ¹é…å’Œæ”¿ç­–ç‰¹å¾çš„è¯„åˆ†ç®—æ³•

### âš™ï¸ é…ç½®ç®¡ç†
- **åŠ¨æ€é—¨æˆ·é…ç½®**ï¼šæ”¯æŒåå°é…ç½®ä¸åŒåœ°åŒºçš„æ”¿åºœé—¨æˆ·
- **é…ç½®éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯é—¨æˆ·é…ç½®çš„æœ‰æ•ˆæ€§
- **è¿æ¥æµ‹è¯•**ï¼šæµ‹è¯•é—¨æˆ·ç½‘ç«™çš„å¯è®¿é—®æ€§
- **é…ç½®å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒæ‰¹é‡å¯¼å…¥å¯¼å‡ºé—¨æˆ·é…ç½®
- **å±‚çº§ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†åœ°æ–¹-çœçº§çš„å±‚çº§å…³ç³»

### ğŸ¤– æ¡†æ¶é›†æˆ
- **LlamaIndexé›†æˆ**ï¼šå®Œå…¨é›†æˆåˆ°LlamaIndexä»£ç†å·¥å…·é“¾
- **MCPå·¥å…·æ ‡å‡†**ï¼šéµå¾ªMCPå·¥å…·åè®®ï¼Œæ”¯æŒè·¨ç³»ç»Ÿé›†æˆ
- **å¼‚æ­¥æ”¯æŒ**ï¼šå…¨é¢çš„å¼‚æ­¥APIæ”¯æŒ
- **å·¥å…·ç»„åˆ**ï¼šæä¾›å¤šä¸ªç›¸å…³å·¥å…·çš„ç»„åˆä½¿ç”¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æŠ€æœ¯æ¶æ„é€‰æ‹©

æ ¹æ®é¡¹ç›®ç°æœ‰æ¶æ„ï¼Œæˆ‘ä»¬é‡‡ç”¨ **LlamaIndex + MCPå·¥å…·æ¨¡å¼** çš„æ··åˆæ¶æ„ï¼š

```mermaid
graph TB
    A[ç”¨æˆ·æŸ¥è¯¢] --> B[LlamaIndexä»£ç†]
    B --> C[æ”¿ç­–æ£€ç´¢é€‚é…å™¨]
    C --> D[æ”¿ç­–æ£€ç´¢å·¥å…·]
    D --> E[é—¨æˆ·é…ç½®æœåŠ¡]
    D --> F[åˆ†å±‚æ£€ç´¢é€»è¾‘]
    
    F --> G[åœ°æ–¹é—¨æˆ·æ£€ç´¢]
    F --> H[çœçº§é—¨æˆ·æ£€ç´¢]
    F --> I[æœç´¢å¼•æ“å…œåº•]
    
    E --> J[ç³»ç»Ÿé…ç½®ç®¡ç†]
    E --> K[é»˜è®¤é—¨æˆ·é…ç½®]
    
    G --> L[ç»“æœè´¨é‡è¯„ä¼°]
    H --> L
    I --> L
    
    L --> M[ç»“æœåˆå¹¶æ’åº]
    M --> N[æ ¼å¼åŒ–è¾“å‡º]
    N --> B
```

### ç»„ä»¶æ¶æ„

#### 1. æ ¸å¿ƒå·¥å…·å±‚ (`app/tools/advanced/search/`)
- **PolicySearchTool**: ä¸»è¦çš„æ”¿ç­–æ£€ç´¢å·¥å…·ç±»
- **SearchLevel**: æ£€ç´¢å±‚çº§æšä¸¾
- **PortalConfig**: é—¨æˆ·é…ç½®æ•°æ®ç±»
- **PolicySearchResult**: æ£€ç´¢ç»“æœæ¨¡å‹

#### 2. æœåŠ¡å±‚ (`app/services/system/`)
- **PortalConfigService**: é—¨æˆ·é…ç½®ç®¡ç†æœåŠ¡
- æ”¯æŒCRUDæ“ä½œã€è¿æ¥æµ‹è¯•ã€æ‰¹é‡å¯¼å…¥å¯¼å‡º

#### 3. é€‚é…å™¨å±‚ (`app/frameworks/llamaindex/adapters/`)
- **PolicySearchAdapter**: LlamaIndexé›†æˆé€‚é…å™¨
- æä¾›å·¥å…·åˆ›å»ºã€ä»£ç†é›†æˆåŠŸèƒ½

#### 4. APIå±‚ (`app/api/frontend/system/`)
- **portal_config.py**: é—¨æˆ·é…ç½®ç®¡ç†API
- æä¾›RESTfulæ¥å£ä¾›å‰ç«¯ç®¡ç†

#### 5. é…ç½®å±‚ (`migrations/sql/common/`)
- æ•°æ®åº“è¿ç§»è„šæœ¬
- é»˜è®¤é…ç½®åˆå§‹åŒ–

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. æ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡Œæ”¿ç­–æ£€ç´¢é…ç½®è¿ç§»
psql -h localhost -U postgres -d knowledge_qa -f migrations/sql/common/03_policy_search_configs.sql
```

### 2. ç¯å¢ƒé…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# æ”¿ç­–æ£€ç´¢åŠŸèƒ½é…ç½®
POLICY_SEARCH_ENABLED=true
POLICY_SEARCH_DEFAULT_STRATEGY=auto
POLICY_SEARCH_MAX_RESULTS=10
POLICY_SEARCH_CONNECTION_TIMEOUT=30
POLICY_SEARCH_QUALITY_THRESHOLD=0.6
POLICY_SEARCH_ENABLE_FALLBACK=true
```

### 3. æœåŠ¡å¯åŠ¨

æ”¿ç­–æ£€ç´¢å·¥å…·ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

```python
from app.tools.advanced.search.policy_search_tool import get_policy_search_tool

# åˆ›å»ºå·¥å…·å®ä¾‹
tool = get_policy_search_tool()

# æ‰§è¡Œæœç´¢
result = await tool._arun(
    query="å…»è€æ”¿ç­–",
    region="å…­ç›˜æ°´",
    search_strategy="auto",
    max_results=10
)
print(result)
```

### 2. LlamaIndexä»£ç†é›†æˆ

```python
from llama_index.core.agent import OpenAIAgent
from app.frameworks.llamaindex.adapters.policy_search_adapter import integrate_policy_search_to_agent

# åˆ›å»ºä»£ç†
agent = OpenAIAgent.from_tools([], llm=llm)

# é›†æˆæ”¿ç­–æ£€ç´¢å·¥å…·
integrate_policy_search_to_agent(agent)

# ä½¿ç”¨ä»£ç†è¿›è¡Œæ”¿ç­–æ£€ç´¢
response = agent.chat("å¸®æˆ‘æŸ¥æ‰¾å…­ç›˜æ°´çš„ä¼ä¸šæ‰¶æŒæ”¿ç­–")
```

### 3. MCPå·¥å…·ä½¿ç”¨

```python
from app.tools.advanced.search.policy_search_tool import policy_search

# ç›´æ¥è°ƒç”¨MCPæ³¨å†Œçš„å‡½æ•°
result = await policy_search(
    query="æ•™è‚²è¡¥è´´",
    region="è´µå·",
    search_strategy="auto",
    max_results=5
)
```

### 4. é—¨æˆ·é…ç½®ç®¡ç†

```python
from app.services.system.portal_config_service import get_portal_config_service

service = get_portal_config_service()

# æ·»åŠ æ–°çš„é—¨æˆ·é…ç½®
config = {
    "name": "æ–°åŸå¸‚æ”¿åºœ",
    "level": "municipal", 
    "base_url": "https://www.newcity.gov.cn",
    "search_endpoint": "/search",
    "search_params": {"q": "{query}"},
    "encoding": "utf-8",
    "max_results": 10
}

await service.set_portal_config("æ–°åŸå¸‚", config)

# æµ‹è¯•è¿æ¥
result = await service.test_portal_connection("æ–°åŸå¸‚")
```

## ğŸ”§ é…ç½®ç®¡ç†

### åå°ç®¡ç†ç•Œé¢

é€šè¿‡ API ç«¯ç‚¹ `/api/frontend/system/portal-config` å¯ä»¥ï¼š

1. **æŸ¥çœ‹æ‰€æœ‰é—¨æˆ·é…ç½®**
   ```
   GET /api/frontend/system/portal-config/regions
   ```

2. **æ·»åŠ æ–°çš„é—¨æˆ·é…ç½®**
   ```
   POST /api/frontend/system/portal-config/regions/{region_name}
   ```

3. **æ›´æ–°é—¨æˆ·é…ç½®**
   ```
   PUT /api/frontend/system/portal-config/regions/{region_name}
   ```

4. **åˆ é™¤é—¨æˆ·é…ç½®**
   ```
   DELETE /api/frontend/system/portal-config/regions/{region_name}
   ```

5. **æµ‹è¯•é—¨æˆ·è¿æ¥**
   ```
   POST /api/frontend/system/portal-config/regions/{region_name}/test
   ```

6. **æ‰¹é‡å¯¼å…¥é…ç½®**
   ```
   POST /api/frontend/system/portal-config/import
   ```

### é—¨æˆ·é…ç½®æ ¼å¼

```json
{
  "name": "é—¨æˆ·åç§°",
  "level": "municipal|provincial|county",
  "parent_region": "çˆ¶çº§åœ°åŒºåç§°",
  "base_url": "https://www.example.gov.cn",
  "search_endpoint": "/search/endpoint",
  "search_params": {
    "param1": "value1",
    "searchWord": "{query}"
  },
  "result_selector": ".result-item",
  "encoding": "utf-8",
  "max_results": 10,
  "region_code": "è¡Œæ”¿åŒºåˆ’ä»£ç "
}
```

## ğŸ® æ¼”ç¤ºå’Œæµ‹è¯•

### è¿è¡Œæ¼”ç¤ºè„šæœ¬

```bash
cd zzdsj-backend-api
python scripts/demo/policy_search_demo.py
```

æ¼”ç¤ºåŒ…å«ï¼š
1. åŸºç¡€æ”¿ç­–æ£€ç´¢åŠŸèƒ½
2. ä¸åŒæ£€ç´¢ç­–ç•¥å¯¹æ¯”
3. é—¨æˆ·é…ç½®ç®¡ç†
4. LlamaIndexå·¥å…·é›†æˆ
5. MCPå·¥å…·æ³¨å†ŒéªŒè¯

### æµ‹è¯•ç”¨ä¾‹

ä¸»è¦æµ‹è¯•åœºæ™¯ï¼š
- âœ… åœ°æ–¹é—¨æˆ·æ­£å¸¸æ£€ç´¢
- âœ… çœçº§é—¨æˆ·æ£€ç´¢
- âœ… æœç´¢å¼•æ“å…œåº•
- âœ… è´¨é‡è¯„ä¼°å’Œç­–ç•¥åˆ‡æ¢
- âœ… é—¨æˆ·é…ç½®CRUDæ“ä½œ
- âœ… è¿æ¥æ€§æµ‹è¯•
- âœ… å·¥å…·é›†æˆéªŒè¯

## ğŸ“Š ç›‘æ§å’Œä¼˜åŒ–

### æ€§èƒ½ç›‘æ§

1. **æ£€ç´¢è€—æ—¶ç»Ÿè®¡**
   - é—¨æˆ·å“åº”æ—¶é—´
   - è§£æå¤„ç†æ—¶é—´
   - æ€»ä½“æ£€ç´¢æ—¶é—´

2. **æˆåŠŸç‡ç›‘æ§**
   - å„é—¨æˆ·æ£€ç´¢æˆåŠŸç‡
   - ç»“æœè´¨é‡åˆ†å¸ƒ
   - ç­–ç•¥ä½¿ç”¨ç»Ÿè®¡

3. **é”™è¯¯è¿½è¸ª**
   - é—¨æˆ·è¿æ¥å¤±è´¥
   - è§£æé”™è¯¯ç»Ÿè®¡
   - å¼‚å¸¸æƒ…å†µè®°å½•

### ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¼˜åŒ–**
   - çƒ­é—¨æŸ¥è¯¢ç»“æœç¼“å­˜
   - é—¨æˆ·é…ç½®ç¼“å­˜
   - è¿æ¥çŠ¶æ€ç¼“å­˜

2. **å¹¶å‘ä¼˜åŒ–**
   - å¤šé—¨æˆ·å¹¶è¡Œæœç´¢
   - å¼‚æ­¥å¤„ç†ä¼˜åŒ–
   - è¿æ¥æ± ç®¡ç†

3. **ç®—æ³•ä¼˜åŒ–**
   - ç›¸å…³æ€§è¯„åˆ†ç®—æ³•
   - è´¨é‡è¯„ä¼°æ¨¡å‹
   - ç»“æœå»é‡ç®—æ³•

## ğŸ”® æ‰©å±•è®¡åˆ’

### çŸ­æœŸæ‰©å±•
- [ ] æ”¯æŒæ›´å¤šçœå¸‚é—¨æˆ·é…ç½®
- [ ] å¢åŠ ç»“æœç¼“å­˜æœºåˆ¶
- [ ] ä¼˜åŒ–HTMLè§£æå‡†ç¡®æ€§
- [ ] æ·»åŠ æ›´å¤šæ”¿ç­–ç±»å‹è¯†åˆ«

### ä¸­æœŸæ‰©å±•
- [ ] æ”¯æŒPDFæ–‡æ¡£ç›´æ¥è§£æ
- [ ] å¢åŠ OCRè¯†åˆ«åŠŸèƒ½
- [ ] å®ç°æ™ºèƒ½æ‘˜è¦ç”Ÿæˆ
- [ ] æ·»åŠ æ—¶é—´èŒƒå›´è¿‡æ»¤

### é•¿æœŸæ‰©å±•
- [ ] åŸºäºAIçš„å†…å®¹ç†è§£
- [ ] æ”¿ç­–å…³è”æ€§åˆ†æ
- [ ] ä¸ªæ€§åŒ–æ¨èç®—æ³•
- [ ] å¤šè¯­è¨€æ”¯æŒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MCPå·¥å…·å¼€å‘æŒ‡å—](./mcp_tool_development.md)
- [LlamaIndexé›†æˆæ–‡æ¡£](./llamaindex_integration.md)
- [ç³»ç»Ÿé…ç½®ç®¡ç†](./system_config_management.md)
- [APIæ¥å£æ–‡æ¡£](../api/frontend_api.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œå»ºè®®ï¼š

1. **æ·»åŠ æ–°çš„é—¨æˆ·é…ç½®**
   - åœ¨ `PortalConfigService` ä¸­æ·»åŠ é»˜è®¤é…ç½®
   - æµ‹è¯•é—¨æˆ·è¿æ¥å’Œç»“æœè§£æ
   - æäº¤é…ç½®åˆ°æ•°æ®åº“

2. **ä¼˜åŒ–è§£æç®—æ³•**
   - æ”¹è¿›HTMLç»“æ„è§£æ
   - å¢å¼ºæ”¿ç­–ç±»å‹è¯†åˆ«
   - æå‡ç›¸å…³æ€§è¯„åˆ†å‡†ç¡®æ€§

3. **æ‰©å±•åŠŸèƒ½ç‰¹æ€§**
   - æ·»åŠ æ–°çš„æ£€ç´¢ç­–ç•¥
   - å®ç°æ›´å¤šå·¥å…·é›†æˆ
   - å¢åŠ ç›‘æ§å’Œåˆ†æåŠŸèƒ½

---

**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æŠ€æœ¯æ ˆ**: LlamaIndex + MCP + FastAPI + PostgreSQL  
**ç»´æŠ¤å›¢é˜Ÿ**: AIç³»ç»Ÿå¼€å‘ç»„ 