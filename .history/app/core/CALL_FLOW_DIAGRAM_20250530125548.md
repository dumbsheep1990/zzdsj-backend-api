# ç³»ç»Ÿè°ƒç”¨æµç¨‹è¯¦è§£

## ğŸ“‹ è°ƒç”¨é¡ºåºæ€»è§ˆ

**æ­£ç¡®çš„è°ƒç”¨é¡ºåºæ˜¯ï¼šç”¨æˆ·è¯·æ±‚ â†’ APIå±‚ â†’ Serviceå±‚ â†’ Coreå±‚ â†’ å¤–éƒ¨æœåŠ¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¯·æ±‚   â”‚ â”€â”€â†’ â”‚   APIå±‚     â”‚ â”€â”€â†’ â”‚  Serviceå±‚  â”‚ â”€â”€â†’ â”‚   Coreå±‚    â”‚
â”‚  (HTTP)     â”‚    â”‚ (è·¯ç”±/éªŒè¯)  â”‚    â”‚  (ä¸šåŠ¡é€»è¾‘)  â”‚    â”‚  (æ ¸å¿ƒåŠŸèƒ½)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                                                â–¼
                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                      â”‚  å¤–éƒ¨æœåŠ¡    â”‚
                                                      â”‚ (æ•°æ®åº“/AI)  â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ è¯¦ç»†è°ƒç”¨æµç¨‹

### 1. èŠå¤©è¯·æ±‚å®Œæ•´æµç¨‹ç¤ºä¾‹

```
1ï¸âƒ£ ç”¨æˆ·å‘é€è¯·æ±‚
   POST /api/v1/chat/message
   Body: { "message": "ä½ å¥½", "conversation_id": 123 }

2ï¸âƒ£ APIå±‚å¤„ç† (app/api/v1/routes/chat.py)
   â”œâ”€â”€ éªŒè¯è¯·æ±‚å‚æ•°
   â”œâ”€â”€ è§£æJWTä»¤ç‰Œ
   â””â”€â”€ è°ƒç”¨ ChatService

3ï¸âƒ£ Serviceå±‚å¤„ç† (app/services/chat_service.py)
   â”œâ”€â”€ è·å–ä¼šè¯ä¿¡æ¯
   â”œâ”€â”€ éªŒè¯ç”¨æˆ·æƒé™
   â”œâ”€â”€ è°ƒç”¨ ChatManager (Coreå±‚)
   â””â”€â”€ å¤„ç†ä¸šåŠ¡é€»è¾‘

4ï¸âƒ£ Coreå±‚å¤„ç† (app/core/chat_manager/manager.py)
   â”œâ”€â”€ ç®¡ç†ä¼šè¯çŠ¶æ€
   â”œâ”€â”€ è°ƒç”¨ ModelManager
   â””â”€â”€ å¤„ç†æ¶ˆæ¯é€»è¾‘

5ï¸âƒ£ Coreå±‚è°ƒç”¨å¤–éƒ¨æœåŠ¡ (app/core/model_manager/manager.py)
   â”œâ”€â”€ è°ƒç”¨OpenAI API
   â”œâ”€â”€ å¤„ç†AIå“åº”
   â””â”€â”€ è¿”å›ç»“æœ

6ï¸âƒ£ å“åº”è¿”å›
   Coreå±‚ â†’ Serviceå±‚ â†’ APIå±‚ â†’ ç”¨æˆ·
```

## ğŸ—ï¸ å±‚æ¬¡èŒè´£è¯´æ˜

### APIå±‚ (æœ€ä¸Šå±‚) - å…¥å£å±‚
**èŒè´£ï¼š** æ¥æ”¶å’Œå¤„ç†HTTPè¯·æ±‚
- ğŸšª è¯·æ±‚è·¯ç”±åˆ†å‘
- âœ… å‚æ•°éªŒè¯
- ğŸ” èº«ä»½è®¤è¯
- ğŸ“ å“åº”æ ¼å¼åŒ–

**ä¸è´Ÿè´£ï¼š** ä¸šåŠ¡é€»è¾‘å¤„ç†

### Serviceå±‚ (ä¸­é—´å±‚) - ä¸šåŠ¡å±‚  
**èŒè´£ï¼š** å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
- ğŸ¢ ä¸šåŠ¡è§„åˆ™å®ç°
- ğŸ”’ æƒé™æ§åˆ¶
- ğŸ“Š æ•°æ®å¤„ç†
- ğŸ”„ äº‹åŠ¡ç®¡ç†

**è°ƒç”¨ï¼š** Coreå±‚æä¾›çš„åŠŸèƒ½
**è¢«è°ƒç”¨ï¼š** è¢«APIå±‚è°ƒç”¨

### Coreå±‚ (åº•å±‚) - æ ¸å¿ƒå±‚
**èŒè´£ï¼š** æä¾›æ ¸å¿ƒåŠŸèƒ½å’Œæ¡†æ¶èƒ½åŠ›
- ğŸ¤– æ™ºèƒ½ä½“ç®¡ç†
- ğŸ§  æ¨¡å‹è°ƒç”¨
- ğŸ› ï¸ å·¥å…·ç¼–æ’
- ğŸ’¬ æ¶ˆæ¯å¤„ç†

**è¢«è°ƒç”¨ï¼š** è¢«Serviceå±‚è°ƒç”¨
**è°ƒç”¨ï¼š** å¤–éƒ¨æœåŠ¡å’Œæ•°æ®åº“

## ğŸ“ å…·ä½“ä»£ç è°ƒç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šèŠå¤©åŠŸèƒ½è°ƒç”¨é“¾

```python
# 1. APIå±‚ (app/api/v1/routes/chat.py)
@router.post("/message")
async def send_message(request: ChatRequest, db: Session = Depends(get_db)):
    # APIå±‚åªè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘
    chat_service = ChatService(db)  # åˆ›å»ºServiceå±‚å®ä¾‹
    result = await chat_service.process_message(request)  # è°ƒç”¨Serviceå±‚
    return result

# 2. Serviceå±‚ (app/services/chat_service.py)
class ChatService:
    def __init__(self, db: Session):
        self.db = db
        # Serviceå±‚å®ä¾‹åŒ–Coreå±‚ç»„ä»¶
        self.chat_manager = ChatManager()  # åˆ›å»ºCoreå±‚å®ä¾‹
    
    async def process_message(self, request: ChatRequest):
        # Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
        conversation = self.get_conversation(request.conversation_id)
        
        # è°ƒç”¨Coreå±‚å¤„ç†æ ¸å¿ƒåŠŸèƒ½
        response = await self.chat_manager.process_chat(
            message=request.message,
            context=conversation.context
        )
        
        # Serviceå±‚å¤„ç†ä¸šåŠ¡è§„åˆ™ï¼ˆä¿å­˜åˆ°æ•°æ®åº“ç­‰ï¼‰
        self.save_message(conversation, request.message, response)
        return response

# 3. Coreå±‚ (app/core/chat_manager/manager.py)
class ChatManager:
    def __init__(self):
        # Coreå±‚å¯ä»¥è°ƒç”¨å…¶ä»–Coreç»„ä»¶
        self.model_manager = ModelManager()
    
    async def process_chat(self, message: str, context: dict):
        # Coreå±‚å¤„ç†æ ¸å¿ƒé€»è¾‘
        formatted_messages = self.format_messages(message, context)
        
        # Coreå±‚è°ƒç”¨å¦ä¸€ä¸ªCoreç»„ä»¶
        ai_response = await self.model_manager.chat_completion(
            messages=formatted_messages
        )
        
        return ai_response

# 4. Coreå±‚è°ƒç”¨å¤–éƒ¨æœåŠ¡ (app/core/model_manager/manager.py)
class ModelManager:
    async def chat_completion(self, messages: list):
        # Coreå±‚è°ƒç”¨å¤–éƒ¨AIæœåŠ¡
        response = await openai_client.chat.completions.create(
            model="gpt-4",
            messages=messages
        )
        return response.choices[0].message.content
```

### ç¤ºä¾‹2ï¼šæ™ºèƒ½ä½“åˆ›å»ºè°ƒç”¨é“¾

```python
# 1. APIå±‚æ¥æ”¶è¯·æ±‚
POST /api/v1/agents/definitions

# 2. APIå±‚è°ƒç”¨Serviceå±‚
agent_service.create_agent_definition(data)

# 3. Serviceå±‚è°ƒç”¨Coreå±‚
agent_builder.build_from_definition(definition_id)

# 4. Coreå±‚è°ƒç”¨å…¶ä»–Coreç»„ä»¶
model_manager.test_connection(model_config)

# 5. Coreå±‚è°ƒç”¨å¤–éƒ¨æœåŠ¡
å¤–éƒ¨AIæ¨¡å‹APIè°ƒç”¨
```

## âŒ å¸¸è§è¯¯è§£æ¾„æ¸…

### è¯¯è§£1ï¼šCoreå±‚åœ¨Serviceå±‚ä¹‹åè°ƒç”¨
```
âŒ é”™è¯¯ç†è§£ï¼šAPI â†’ Service â†’ å¤–éƒ¨æœåŠ¡ â†’ Core
âœ… æ­£ç¡®ç†è§£ï¼šAPI â†’ Service â†’ Core â†’ å¤–éƒ¨æœåŠ¡
```

### è¯¯è§£2ï¼šCoreå±‚æ˜¯æœ€ä¸Šå±‚
```
âŒ é”™è¯¯ç†è§£ï¼šCoreæ˜¯æ§åˆ¶å±‚ï¼Œåœ¨æœ€ä¸Šé¢
âœ… æ­£ç¡®ç†è§£ï¼šCoreæ˜¯åŸºç¡€å±‚ï¼Œåœ¨æœ€ä¸‹é¢
```

### è¯¯è§£3ï¼šAPIå±‚ç›´æ¥è°ƒç”¨Coreå±‚
```
âŒ é”™è¯¯ç†è§£ï¼šAPI â†’ Core â†’ Service
âœ… æ­£ç¡®ç†è§£ï¼šAPI â†’ Service â†’ Core
```

## ğŸ¯ è®°å¿†æŠ€å·§

**æƒ³è±¡æˆä¸€ä¸ªå…¬å¸çš„ç»„ç»‡æ¶æ„ï¼š**

- **APIå±‚** = å‰å°æ¥å¾…å‘˜ï¼ˆæ¥æ”¶å®¢æˆ·è¯·æ±‚ï¼‰
- **Serviceå±‚** = ä¸šåŠ¡ç»ç†ï¼ˆå¤„ç†å…·ä½“ä¸šåŠ¡ï¼‰
- **Coreå±‚** = æŠ€æœ¯ä¸“å®¶ï¼ˆæä¾›ä¸“ä¸šæŠ€èƒ½ï¼‰
- **å¤–éƒ¨æœåŠ¡** = å¤–åŒ…å…¬å¸ï¼ˆæä¾›å¤–éƒ¨èµ„æºï¼‰

**æµç¨‹ï¼š**
1. å®¢æˆ·æ‰¾å‰å°æ¥å¾…å‘˜ (ç”¨æˆ·è¯·æ±‚API)
2. å‰å°è½¬ç»™ä¸šåŠ¡ç»ç† (APIè°ƒç”¨Service)  
3. ä¸šåŠ¡ç»ç†æ‰¾æŠ€æœ¯ä¸“å®¶ (Serviceè°ƒç”¨Core)
4. æŠ€æœ¯ä¸“å®¶è”ç³»å¤–åŒ…å…¬å¸ (Coreè°ƒç”¨å¤–éƒ¨æœåŠ¡)

## ğŸ” è°ƒç”¨æ–¹å‘æ€»ç»“

```
è°ƒç”¨æ–¹å‘ï¼šä¸Šå±‚ â†’ ä¸‹å±‚
æ•°æ®æµå‘ï¼šè¯·æ±‚ä¸‹ä¼ ï¼Œå“åº”ä¸Šä¼ 

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è°ƒç”¨
â”‚   APIå±‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (æœ€ä¸Šå±‚)     â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è°ƒç”¨
                â”‚  Serviceå±‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ (ä¸­é—´å±‚)     â”‚         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è°ƒç”¨
                                â”‚   Coreå±‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ (åº•å±‚)      â”‚         â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚  å¤–éƒ¨æœåŠ¡    â”‚
                                                â”‚             â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¸Œæœ›è¿™æ ·è§£é‡Šèƒ½è®©æ‚¨æ›´æ¸…æ¥šåœ°ç†è§£è°ƒç”¨é¡ºåºï¼Coreå±‚æ˜¯è¢«Serviceå±‚è°ƒç”¨çš„åŸºç¡€åŠŸèƒ½å±‚ï¼Œä¸æ˜¯åœ¨Serviceå±‚ä¹‹åè°ƒç”¨çš„æ§åˆ¶å±‚ã€‚ 